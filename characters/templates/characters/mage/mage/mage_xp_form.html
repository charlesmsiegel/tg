<div class="row">
    <h2 class="col-sm {{ object.get_heading }} pointer"
        data-toggle="collapse"
        data-target="#xpSection"
        aria-expanded="true"
        aria-controls="xpSection">Experience</h2>
</div>
<div id="xpSection" class="collapse show multi-collapse">
    <div class="row">
        <div class="col-sm">XP Remaining</div>
        <div class="col-sm">{{ object.xp }}</div>
    </div>
    <div class="row">
        <div class="col-sm">Spend Freebie points. The costs are as follows:</div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">
            <b>Trait</b>
        </div>
        <div class="col-sm-3 border">
            <b>Cost</b>
        </div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Attribute</div>
        <div class="col-sm-3 border">4 x Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">New Ability</div>
        <div class="col-sm-3 border">3</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Ability</div>
        <div class="col-sm-3 border">2 x Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Background (new)</div>
        <div class="col-sm-3 border">5</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Background (existing)</div>
        <div class="col-sm-3 border">3 x Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Willpower</div>
        <div class="col-sm-3 border">Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Merits</div>
        <div class="col-sm-3 border">3 x (New Rating - Current Rating)</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">New Sphere</div>
        <div class="col-sm-3 border">10</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Affinity Sphere</div>
        <div class="col-sm-3 border">7 x Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Sphere</div>
        <div class="col-sm-3 border">8 x Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Three Rote Points</div>
        <div class="col-sm-3 border">1</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">New Resonance</div>
        <div class="col-sm-3 border">5</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Resonance</div>
        <div class="col-sm-3 border">3 x Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Tenet</div>
        <div class="col-sm-3 border">0</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Remove Tenet</div>
        <div class="col-sm-3 border">Number of Tenets</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">New Practice</div>
        <div class="col-sm-3 border">3</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Practice</div>
        <div class="col-sm-3 border">Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <div class="row centertext">
        <div class="col-sm-3"></div>
        <div class="col-sm-3 border">Arete</div>
        <div class="col-sm-3 border">8 x Current Rating</div>
        <div class="col-sm-3"></div>
    </div>
    <form action="" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        {% for request in object.get_xp_spending_history %}
            <div class="row">
                <div class="col-sm">
                    {{ request.trait_name }}
                    {% if request.trait_value %}({{ request.trait_value }}){% endif %}
                </div>
                <div class="col-sm">{{ request.cost }} XP</div>
                <div class="col-sm">{{ request.approved }}</div>
                {% if user.profile.is_st %}
                    {% if request.approved != "Approved" %}
                        <div class="col-sm">
                            <input type="submit" name="xp_request_{{ request.id }}_approve" value="Approve" />
                            <input type="submit" name="xp_request_{{ request.id }}_reject" value="Reject" />
                        </div>
                    {% else %}
                        <div class="col-sm"></div>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
        <div class="row">
            <div class="col-sm">{{ form.category }}</div>
            <div class="col-sm d-none" id="example_wrap">{{ form.example }}</div>
            <div class="col-sm d-none" id="resonance_wrap">{{ form.resonance }}</div>
            <div class="col-sm d-none" id="value_wrap">{{ form.value }}</div>
            <div class="col-sm d-none" id="note_wrap">{{ form.note }}</div>
            <div class="col-sm d-none" id="pooled_wrap">Pooled? {{ form.pooled }}</div>
            <div class="col-sm d-none" id="image_field_wrap">{{ form.image_field }}</div>
        </div>
        <div class="d-none" id="rote_wrap">
            <div class="row">
                <div class="col-sm">Create New Rote: {{ rote_form.select_or_create_rote }}</div>
            </div>
            <div id="rote selection">
                <div class="row">
                    <div class="col-sm">{{ rote_form.rote_options }}</div>
                </div>
            </div>
            <div id="rote creation" class="d-none">
                <div class="row">
                    <div class="col-sm">Name</div>
                    <div class="col-sm">{{ rote_form.name }}</div>
                </div>
                <div class="row">
                    <div class="col-sm">Practice</div>
                    <div class="col-sm">{{ rote_form.practice }}</div>
                </div>
                <div class="row">
                    <div class="col-sm">Dicepool</div>
                    <div class="col-sm">{{ rote_form.attribute }} + {{ rote_form.ability }}</div>
                </div>
                <div class="row">
                    <div class="col-sm">Description</div>
                    <div class="col-sm">{{ rote_form.description }}</div>
                </div>
                <div class="row">
                    <div class="col-sm">Create New Effect: {{ rote_form.select_or_create_effect }}</div>
                </div>
                <div id="effect selection">
                    <div class="row">
                        <div class="col-sm">{{ rote_form.effect_options }}</div>
                    </div>
                </div>
                <div id="effect creation" class="d-none">
                    <div class="row">
                        <div class="col-sm-2">Correspondence</div>
                        <div class="col-sm-2 dots">{{ rote_form.correspondence }}</div>
                        <div class="col-sm-2">Life</div>
                        <div class="col-sm-2 dots">{{ rote_form.life }}</div>
                        <div class="col-sm-2">Prime</div>
                        <div class="col-sm-2 dots">{{ rote_form.prime }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-2">Entropy</div>
                        <div class="col-sm-2 dots">{{ rote_form.entropy }}</div>
                        <div class="col-sm-2">Matter</div>
                        <div class="col-sm-2 dots">{{ rote_form.matter }}</div>
                        <div class="col-sm-2">Spirit</div>
                        <div class="col-sm-2 dots">{{ rote_form.spirit }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-2">Forces</div>
                        <div class="col-sm-2 dots">{{ rote_form.forces }}</div>
                        <div class="col-sm-2">Mind</div>
                        <div class="col-sm-2 dots">{{ rote_form.mind }}</div>
                        <div class="col-sm-2">Time</div>
                        <div class="col-sm-2 dots">{{ rote_form.time }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm">Systems</div>
                        <div class="col-sm">{{ rote_form.systems }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm">
                <input type="submit" name="spend_xp" value="Spend XP/Rote Points" />
            </div>
        </div>
        {% if form.non_field_errors %}
            {% for error in form.non_field_errors %}<p class="alert centertext">{{ error }}</p>{% endfor %}
        {% endif %}
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const categorySelectMenu = document.getElementById("id_category");
        const exampleSelectMenu = document.getElementById("id_example")
        const exampleElement = document.getElementById("example_wrap");
        const valueElement = document.getElementById("value_wrap");
        const resElement = document.getElementById("resonance_wrap");
        const noteElement = document.getElementById("note_wrap");
        const pooled_wrap = document.getElementById("pooled_wrap");
        const image_field_wrap = document.getElementById("image_field_wrap");
        const rote_wrap = document.getElementById("rote_wrap");

        var isGroupMember = {{ object.is_group_member|lower }};
    
        categorySelectMenu.addEventListener("change", function() {
            const selectedValue = this.value;
            
            // Update the class of the element
            if(["Willpower", "-----", "Rote Points", "Quintessence"].includes(this.value)){
                exampleElement.classList.add("d-none");
                valueElement.classList.add("d-none");
                noteElement.classList.add("d-none");
                resElement.classList.add("d-none");
                pooled_wrap.classList.add("d-none");
                image_field_wrap.classList.add("d-none")
                rote_wrap.classList.add("d-none")
            } else {
                exampleElement.classList.remove("d-none");
                valueElement.classList.add("d-none");
                noteElement.classList.add("d-none");
                resElement.classList.add("d-none");
                pooled_wrap.classList.add("d-none");
                image_field_wrap.classList.add("d-none")
                rote_wrap.classList.add("d-none")
            }
            if(this.value == "Rote"){
                exampleElement.classList.add("d-none")
                valueElement.classList.add("d-none");
                resElement.classList.add("d-none");
                noteElement.classList.add("d-none");
                pooled_wrap.classList.add("d-none");
                image_field_wrap.classList.add("d-none")
                rote_wrap.classList.remove("d-none")
            }
            if(this.value == "MeritFlaw"){
                valueElement.classList.remove("d-none");
                resElement.classList.add("d-none");
                noteElement.classList.add("d-none");
                pooled_wrap.classList.add("d-none");
                image_field_wrap.classList.add("d-none")
                rote_wrap.classList.add("d-none")
            }
            if(this.value == "Resonance"){
                resElement.classList.remove("d-none");
                exampleElement.classList.add("d-none");
                noteElement.classList.add("d-none");
                valueElement.classList.add("d-none");
                pooled_wrap.classList.add("d-none");
                image_field_wrap.classList.add("d-none")
                rote_wrap.classList.add("d-none")
            }
            if(this.value == "Background"){
                resElement.classList.add("d-none");
                exampleElement.classList.remove("d-none");
                noteElement.classList.remove("d-none");
                valueElement.classList.add("d-none");
                rote_wrap.classList.add("d-none")
                if (isGroupMember) {
                    pooled_wrap.classList.remove("d-none");
                } else {
                    pooled_wrap.classList.add("d-none");
                }
                image_field_wrap.classList.add("d-none")
            }
            if(this.value == "Arete"){
                resElement.classList.add("d-none")
                exampleElement.classList.add("d-none");;
                noteElement.classList.add("d-none");
                valueElement.classList.add("d-none");
                pooled_wrap.classList.add("d-none");
                image_field_wrap.classList.add("d-none")
                rote_wrap.classList.add("d-none")
            }
            if(this.value == "Image"){
                resElement.classList.add("d-none")
                exampleElement.classList.add("d-none");;
                noteElement.classList.add("d-none");
                valueElement.classList.add("d-none");
                pooled_wrap.classList.add("d-none");
                image_field_wrap.classList.remove("d-none")
                rote_wrap.classList.add("d-none")
            }
            
            // Make the AJAX call
            $.ajax({
                url: '{% url 'characters:mage:ajax:load_xp_examples' %}',
                data: {
                    'category': this.value,
                    'object': {{object.id}}
                },
                success: function (data) {
                    populateDropdown('#id_example', data.options);
                    populateDropdownFromValues('#id_value', []);
                }
            });
        });

        exampleSelectMenu.addEventListener("change", function() {
            const selectedValue = this.value;
            if(categorySelectMenu.value == "MeritFlaw"){
                $.ajax({
                    url: '{% url 'characters:ajax:load_values' %}',
                    data: {
                        'example': this.value,
                        'object': {{object.id}},
                        'xp': 'true'
                    },
                    success: function (data) {
                        populateDropdownFromValues('#id_value', data.values);
                    }
                });
            }
            // Hide pooled checkbox for non-poolable backgrounds
            if(categorySelectMenu.value == "Background" && isGroupMember){
                if (isSelectedOptionPoolable('#id_example')) {
                    pooled_wrap.classList.remove("d-none");
                } else {
                    pooled_wrap.classList.add("d-none");
                }
            }
        });
    });

</script>
<script type="text/javascript">
    $(document).ready(function(){
        $('#id_practice').change(function(){
            var practiceId = $(this).val();
            $.ajax({
                url: "{% url 'characters:mage:ajax:get_abilities' %}",  // Your AJAX view URL
                data: {
                    'practice_id': practiceId,
                    'object': {{ object.id }}
                },
                success: function(data) {
                    var $abilitySelect = $('#id_ability');
                    $abilitySelect.empty();
                    $.each(data, function(index, item) {
                        $abilitySelect.append($('<option>', { 
                            value: item.id,
                            text : item.name 
                        }));
                    });
                }
            });
        });
    });

    $(document).ready(function() {
        $('#id_select_or_create_rote').click(function() {
            $('#id_ability').empty();
            $('#id_ability').append($('<option>', { value: '', text: '--------' }));
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Select all elements with data-toggle="toggle"
        const rote_creation_toggle = document.getElementById('id_select_or_create_rote');
        const effect_creation_toggle = document.getElementById('id_select_or_create_effect');
        const rote_creation = document.getElementById('rote creation');
        const rote_selection = document.getElementById('rote selection');
        const effect_creation = document.getElementById('effect creation');
        const effect_selection = document.getElementById('effect selection');
        
        // Attach event listener to each toggle
        rote_creation_toggle.addEventListener('change', function() {
            if ($(this).prop('checked')) {
                rote_selection.classList.add("d-none");
                rote_creation.classList.remove("d-none");
            } else {
                rote_creation.classList.add("d-none")
                rote_selection.classList.remove("d-none")
            }
        });

        effect_creation_toggle.addEventListener('change', function() {
            if ($(this).prop('checked')) {
                effect_selection.classList.add("d-none");
                effect_creation.classList.remove("d-none");
            } else {
                effect_selection.classList.add("d-none")
                effect_creation.classList.remove("d-none")
            }
        });
    });

    
</script>
