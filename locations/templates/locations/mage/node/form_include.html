{% load formset_tags %}
<!-- Instructions Card -->
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Node Creation Guide</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        <p class="mb-2">Nodes are created as per <strong>Sources of Magick</strong> rules. A node has <strong>3 points per rank</strong>.</p>
        <p class="mb-2">
            Points are divided between Merits and Flaws (at cost), Size and Ratio (from -2 to 2),
            additional Resonance (1 each after {{ current_node.rating }} ranks of resonance) and
            total tass/quintessence generated. Additionally, choose the thematic form of the Quintessence and Tass.
        </p>
        <p class="mb-0">
            Nodes contain reality zones equal to their rank. Choose {{ current_node.rating }} positive levels
            of Practices and the same number of negative levels.
        </p>
    </div>
</div>

<!-- Basic Information -->
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Basic Information</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="{{ form.name.id_for_label }}" class="form-label">Name</label>
                {{ form.name }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.contained_within.id_for_label }}" class="form-label">Contained Within</label>
                {{ form.contained_within }}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="{{ form.rank.id_for_label }}" class="form-label">Rank</label>
                {{ form.rank }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.size.id_for_label }}" class="form-label">Size</label>
                {{ form.size }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.ratio.id_for_label }}" class="form-label">Ratio</label>
                {{ form.ratio }}
            </div>
        </div>
    </div>
</div>

<!-- Dimensional Barriers -->
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Dimensional Barriers</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="{{ form.gauntlet.id_for_label }}" class="form-label">Gauntlet</label>
                {{ form.gauntlet }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.shroud.id_for_label }}" class="form-label">Shroud</label>
                {{ form.shroud }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.dimension_barrier.id_for_label }}" class="form-label">Dimension Barrier</label>
                {{ form.dimension_barrier }}
            </div>
        </div>
    </div>
</div>

<!-- Energy Output -->
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Energy Output</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="{{ form.quintessence_form.id_for_label }}" class="form-label">Quintessence Form</label>
                {{ form.quintessence_form }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.tass_form.id_for_label }}" class="form-label">Tass Form</label>
                {{ form.tass_form }}
            </div>
        </div>
    </div>
</div>

<!-- Merits and Flaws -->
{% if merits_and_flaws.count != 0 %}
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Merits and Flaws</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        {{ form.merit_flaw_formset.management_form }}
        <div id="merit_flaw_formset" {% formset_container "merit_flaw" %}>
            {% for subform in form.merit_flaw_formset.forms %}
                <div class="row mb-3 merit-flaw-row" {% formset_form_wrapper %}>
                    <div class="col-md-6">
                        <label class="form-label">Merit/Flaw</label>
                        {{ subform.mf }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rating</label>
                        {{ subform.rating }}
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" {% formset_remove_btn "merit_flaw" %} class="tg-btn btn-danger btn-sm" style="margin-bottom: 0.5rem;">Remove</button>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="empty_merit_flaw_form" class="d-none">
            <div class="row mb-3 merit-flaw-row" {% formset_form_wrapper %}>
                <div class="col-md-6">
                    <label class="form-label">Merit/Flaw</label>
                    {{ form.merit_flaw_formset.empty_form.mf }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rating</label>
                    {{ form.merit_flaw_formset.empty_form.rating }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" {% formset_remove_btn "merit_flaw" %} class="tg-btn btn-danger btn-sm" style="margin-bottom: 0.5rem;">Remove</button>
                </div>
            </div>
        </div>
        <div class="text-center mt-3">
            {% formset_add_btn "merit_flaw" "<i class='fas fa-plus mr-1'></i> Add Merit/Flaw" class="tg-btn btn-primary" %}
        </div>
    </div>
</div>
{% endif %}

<!-- Resonance -->
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Resonance</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        {{ form.resonance_formset.management_form }}
        <div id="resonance_formset" {% formset_container "resonance" %}>
            {% for subform in form.resonance_formset.forms %}
                <div class="row mb-3 resonance-row" {% formset_form_wrapper %}>
                    <div class="col-md-6">
                        <label class="form-label">Resonance Type</label>
                        {{ subform.resonance }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rating</label>
                        {{ subform.rating }}
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" {% formset_remove_btn "resonance" %} class="tg-btn btn-danger btn-sm" style="margin-bottom: 0.5rem;">Remove</button>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="empty_resonance_form" class="d-none">
            <div class="row mb-3 resonance-row" {% formset_form_wrapper %}>
                <div class="col-md-6">
                    <label class="form-label">Resonance Type</label>
                    {{ form.resonance_formset.empty_form.resonance }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rating</label>
                    {{ form.resonance_formset.empty_form.rating }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" {% formset_remove_btn "resonance" %} class="tg-btn btn-danger btn-sm" style="margin-bottom: 0.5rem;">Remove</button>
                </div>
            </div>
        </div>
        <div class="text-center mt-3">
            {% formset_add_btn "resonance" "<i class='fas fa-plus mr-1'></i> Add Resonance" class="tg-btn btn-primary" %}
        </div>
    </div>
</div>

<!-- Reality Zone -->
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Reality Zone</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        {{ form.reality_zone_formset.management_form }}
        <div id="reality_zone_formset" {% formset_container "reality_zone" %}>
            {% for subform in form.reality_zone_formset.forms %}
                <div class="row mb-3 reality-zone-row" {% formset_form_wrapper %}>
                    <div class="col-md-6">
                        <label class="form-label">Practice</label>
                        {{ subform.practice }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rating</label>
                        {{ subform.rating }}
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" {% formset_remove_btn "reality_zone" %} class="tg-btn btn-danger btn-sm" style="margin-bottom: 0.5rem;">Remove</button>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="empty_reality_zone_form" class="d-none">
            <div class="row mb-3 reality-zone-row" {% formset_form_wrapper %}>
                <div class="col-md-6">
                    <label class="form-label">Practice</label>
                    {{ form.reality_zone_formset.empty_form.practice }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rating</label>
                    {{ form.reality_zone_formset.empty_form.rating }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" {% formset_remove_btn "reality_zone" %} class="tg-btn btn-danger btn-sm" style="margin-bottom: 0.5rem;">Remove</button>
                </div>
            </div>
        </div>
        <div class="text-center mt-3">
            {% formset_add_btn "reality_zone" "<i class='fas fa-plus mr-1'></i> Add Reality Zone Rating" class="tg-btn btn-primary" %}
        </div>
    </div>
</div>

<!-- Description -->
<div class="tg-card mb-4">
    <div class="tg-card-header">
        <h2 class="tg-card-title mta_heading">Description</h2>
    </div>
    <div class="tg-card-body" style="padding: 24px;">
        {{ form.description }}
    </div>
</div>

{% formset_script %}
