{% extends "core/base.html" %}
{% load field %}
{% load sanitize_text %}
{% load location_tags %}

{% block title %}
    {{ gameline }} Locations
{% endblock title %}

{% block styling %}
{{ block.super }}
<style>
    /* Enhanced tab styling */
    .tg-nav-tabs .tg-nav-link:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }
    
    /* Smooth collapse animation */
    .collapse {
        transition: height 0.3s ease;
    }
    
    /* Rotate chevron when collapsed */
    .collapsed .fa-chevron-down {
        transform: rotate(-90deg);
    }
    
    /* Enhanced table row hover */
    .tg-table tbody tr:hover {
        transform: translateX(4px);
        box-shadow: -4px 0 0 var(--color-primary);
    }
    
    /* Add more padding to table cells */
    .tg-table tbody td {
        padding: var(--spacing-3) var(--spacing-4);
        white-space: nowrap;
    }
    
    /* Allow badge columns to wrap if needed */
    .tg-table tbody td:nth-child(3),
    .tg-table tbody td:nth-child(4) {
        white-space: normal;
    }
    
    /* Link hover effects */
    .tg-table a:hover {
        opacity: 0.8;
    }
    
    /* Form button hover */
    .tg-btn.btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md) !important;
    }
    
    /* Badge animations */
    .tg-badge {
        transition: var(--transition-fast);
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .tg-badge:hover {
        transform: scale(1.05);
    }
    
    /* Ensure badges in table cells have proper sizing */
    .tg-table .tg-badge {
        font-size: var(--font-size-xs);
        padding: 0.35em 0.75em;
        white-space: nowrap;
    }
    
    /* Gameline-specific badge colors for location types */
    .tg-badge.badge-type-vtm {
        background-color: var(--gameline-vtm);
        color: var(--color-white);
    }
    
    .tg-badge.badge-type-wta {
        background-color: var(--gameline-wta);
        color: var(--color-white);
    }
    
    .tg-badge.badge-type-mta {
        background-color: var(--gameline-mta);
        color: var(--color-white);
    }
    
    .tg-badge.badge-type-ctd {
        background-color: #20b2aa;
        color: var(--color-white);
    }
    
    .tg-badge.badge-type-wto {
        background-color: var(--gameline-wto);
        color: var(--color-white);
    }
    
    /* Dark theme adjustments */
    @media (prefers-color-scheme: dark) {
        :root:not(.theme-light) .tg-badge.badge-type-vtm {
            background-color: #dc143c;
        }
        
        :root:not(.theme-light) .tg-badge.badge-type-wta {
            background-color: #32cd32;
        }
        
        :root:not(.theme-light) .tg-badge.badge-type-mta {
            background-color: #9370db;
        }
        
        :root:not(.theme-light) .tg-badge.badge-type-ctd {
            background-color: #48d1cc;
        }
        
        :root:not(.theme-light) .tg-badge.badge-type-wto {
            background-color: #708090;
        }
    }
    
    .theme-dark .tg-badge.badge-type-vtm {
        background-color: #dc143c;
    }
    
    .theme-dark .tg-badge.badge-type-wta {
        background-color: #32cd32;
    }
    
    .theme-dark .tg-badge.badge-type-mta {
        background-color: #9370db;
    }
    
    .theme-dark .tg-badge.badge-type-ctd {
        background-color: #48d1cc;
    }
    
    .theme-dark .tg-badge.badge-type-wto {
        background-color: #708090;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .tg-table tbody tr:hover {
            transform: none;
            box-shadow: none;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container py-4">
        <!-- Page Header -->
        <div class="tg-card header-card mb-4">
            <div class="tg-card-header">
                <h1 class="tg-card-title {{ header }}">{{ gameline }} Locations</h1>
            </div>
        </div>

        <!-- Location List -->
        <div class="tg-card mb-4">
            <div class="tg-card-header">
                <ul class="nav nav-tabs card-header-tabs tg-nav-tabs"
                    id="locationTabs"
                    role="tablist"
                    style="border-bottom: none; margin-bottom: 0;">
                    {% for chron in chrondict.keys %}
                        <li class="nav-item">
                            <a class="nav-link tg-nav-link {% if forloop.first %}active{% endif %} {% if chron %}{{ chron.headings }}{% else %}wod_heading{% endif %}"
                               id="tab-{{ chron.id|default:'no-chronicle' }}"
                               data-toggle="tab"
                               href="#chron-{{ chron.id|default:'no-chronicle' }}"
                               role="tab">
                                {% if chron %}
                                    {{ chron.name }}
                                {% else %}
                                    No Chronicle
                                {% endif %}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="tg-card-body">
                <div class="tab-content" id="locationTabsContent">
                    {% for chron in chrondict.keys %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                             id="chron-{{ chron.id|default:'no-chronicle' }}"
                             role="tabpanel">
                            
                            {% if chrondict|field:chron %}
                                <!-- Location Table -->
                                <div class="tg-table-responsive" style="border-radius: var(--border-radius-base); overflow: hidden; box-shadow: var(--shadow-sm);">
                                    <table class="tg-table table-striped" style="margin-bottom: 0;">
                                        <thead>
                                            <tr>
                                                <th style="width: 50%;">
                                                    <i class="fas fa-map-marker-alt mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Location Name
                                                </th>
                                                <th style="width: 30%;">
                                                    <i class="fas fa-user mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Owner
                                                </th>
                                                <th style="width: 20%;">
                                                    <i class="fas fa-tag mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Type
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for loc in chrondict|field:chron %}
                                                {% include "locations/location_table_row.html" with location=loc level=0 %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5" 
                                     style="color: var(--theme-text-muted);
                                            background: var(--theme-bg-secondary);
                                            border: 2px dashed var(--theme-border-color);">
                                    <i class="fas fa-map fa-3x mb-3" style="opacity: 0.3;"></i>
                                    <p class="mb-0" style="font-size: var(--font-size-base);">No locations found for this chronicle.</p>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Create Location -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="tg-card" style="box-shadow: var(--shadow-md); border-top: 4px solid var(--color-primary);">
                    <div class="tg-card-body" style="padding: var(--spacing-5);">
                        <!-- Icon - Left Aligned -->
                        <div style="margin-bottom: var(--spacing-3);">
                            <div style="width: 64px; 
                                       height: 64px; 
                                       background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-success) 100%);
                                       border-radius: 50%;
                                       display: flex;
                                       align-items: center;
                                       justify-content: center;
                                       box-shadow: var(--shadow-md);">
                                <i class="fas fa-map-marked-alt" style="font-size: 28px; color: white;"></i>
                            </div>
                        </div>
                        
                        <!-- Title - Centered -->
                        <h5 class="tg-card-title {{ header }}" style="text-align: center; margin-bottom: var(--spacing-2); font-size: var(--font-size-xl);">
                            Create Location
                        </h5>
                        
                        <!-- Description - Left Aligned -->
                        <p style="color: var(--theme-text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-4); text-align: left;">
                            Add a new location to your chronicle
                        </p>
                        
                        <!-- Form -->
                        <form id="locForm" method="post" novalidate>
                            {% csrf_token %}

                            <!-- Game Line -->
                            <div style="margin-bottom: var(--spacing-3); text-align: left;">
                                <label class="tg-form-label">
                                    <i class="fas fa-book mr-2" style="color: var(--color-primary);"></i>Game Line
                                </label>
                                <select name="gameline" id="id_loc_gameline" class="tg-form-control tg-form-select" required>
                                    {% for value, label in form.gameline.field.choices %}
                                        <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Location Type -->
                            <div style="margin-bottom: var(--spacing-3); text-align: left;">
                                <label class="tg-form-label">
                                    <i class="fas fa-map-marker-alt mr-2" style="color: var(--color-primary);"></i>Location Type
                                </label>
                                {{ form.loc_type }}
                            </div>

                            <!-- Button - Full Width, Centered Text -->
                            <button type="submit"
                                    name="action"
                                    value="create"
                                    class="tg-btn btn-primary btn-lg"
                                    style="width: 100%;
                                           box-shadow: var(--shadow-sm);
                                           transition: var(--transition-fast);
                                           font-weight: 600;
                                           text-align: center;">
                                <i class="fas fa-plus-circle mr-2"></i>Create Location
                            </button>
                        </form>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const gamelineSelect = document.getElementById('id_loc_gameline');
                                const locTypeSelect = document.getElementById('id_loc_type');
                                const typesByGameline = JSON.parse(locTypeSelect.dataset.typesByGameline || '{}');

                                function updateLocTypes() {
                                    const selectedGameline = gamelineSelect.value;
                                    const types = typesByGameline[selectedGameline] || [];

                                    locTypeSelect.innerHTML = '';

                                    types.forEach(function(type) {
                                        const option = document.createElement('option');
                                        option.value = type.value;
                                        option.textContent = type.label;
                                        locTypeSelect.appendChild(option);
                                    });
                                }

                                gamelineSelect.addEventListener('change', updateLocTypes);
                                updateLocTypes();
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}