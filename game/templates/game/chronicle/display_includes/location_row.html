{% load sanitize_text %}
<!-- Location Row (Chronicle version with gameline filtering) -->
<tr class="location-row {% if parent_id %}collapse show{% endif %}"
    {% if parent_id %}id="loc-{{ parent_id }}-children-{{ gameline_code }}"{% endif %}
    style="transition: var(--transition-fast);">
    <td data-label="Location" style="padding-left: {{ level|default:0|add:12 }}px;">
        {% if location.children.exists %}
            <a href="#loc-{{ location.id }}-children-{{ gameline_code }}"
               class="btn btn-link btn-sm p-0 mr-2"
               data-toggle="collapse"
               role="button"
               aria-expanded="true"
               aria-controls="loc-{{ location.id }}-children-{{ gameline_code }}"
               style="color: var(--theme-text-primary);">
                <i class="fas fa-chevron-down" style="transition: transform 0.2s;"></i>
            </a>
        {% else %}
            <span class="mr-2" style="display: inline-block; width: 20px;"></span>
        {% endif %}
        {% if level %}
            <i class="fas fa-level-up-alt fa-rotate-90 mr-2" style="color: var(--theme-text-muted); font-size: 0.75em;"></i>
        {% endif %}
        <a href="{{ location.get_absolute_url }}"
           class="{{ location.gameline }}_heading"
           style="text-decoration: none;
                  font-weight: 600;
                  font-size: var(--font-size-base);
                  transition: var(--transition-fast);">
            {{ location.name|sanitize_html }}
        </a>
    </td>
    <td data-label="Owner">
        {% if location.owner %}
            <a href="{% url 'accounts:profile' location.owner.id %}"
               style="color: var(--theme-text-secondary);
                      text-decoration: none;
                      transition: var(--transition-fast);">
                <i class="fas fa-user mr-1" style="font-size: 0.85em;"></i>{{ location.owner.username }}
            </a>
        {% else %}
            <span style="color: var(--theme-text-muted); font-style: italic;">â€”</span>
        {% endif %}
    </td>
    <td data-label="Type">
        <span class="tg-badge {{ location.get_badge_class }} badge-pill">{{ location.get_type }}</span>
    </td>
</tr>

<!-- Child Locations (Recursive, filtered by allowed_types) -->
{% for child in location.children.all %}
    {% if child.polymorphic_ctype.model in allowed_types %}
        {% include "game/chronicle/display_includes/location_row.html" with location=child level=level|default:0|add:24 parent_id=location.id allowed_types=allowed_types gameline_code=gameline_code %}
    {% endif %}
{% endfor %}
