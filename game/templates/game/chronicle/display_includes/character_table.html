{% regroup character_queryset by group_set.first as grouplist %}
{% if grouplist %}
    <div class="tg-table-responsive" style="border-radius: var(--border-radius-base); overflow: hidden; box-shadow: var(--shadow-sm);">
        <table class="tg-table table-striped" style="margin-bottom: 0;">
            <thead>
                <tr>
                    <th style="width: 3%;"></th>
                    <th style="width: 35%;">
                        <i class="fas fa-user-circle mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Character Name
                    </th>
                    <th style="width: 20%;">
                        <i class="fas fa-gamepad mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Player
                    </th>
                    <th style="width: 22%;">
                        <i class="fas fa-tag mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Type
                    </th>
                    <th style="width: 20%;">
                        <i class="fas fa-info-circle mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Status
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for g in grouplist %}
                    {% if g.list %}
                        <!-- Group Header Row -->
                        <tr class="group-header-row" style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-tertiary) 100%); border-left: 3px solid var(--color-primary);">
                            <td colspan="5" style="padding: var(--spacing-3) var(--spacing-4);">
                                <div class="d-flex align-items-center">
                                    <a href="#group-{{ g.grouper.id|default:'solo' }}-{{ table_id }}" class="mr-2" data-toggle="collapse" role="button" aria-expanded="true" style="padding: 0.25rem 0.5rem; background: transparent; border: none; color: var(--theme-text-primary); cursor: pointer; transition: var(--transition-fast);">
                                        <i class="fas fa-chevron-down" style="transition: transform 0.2s;"></i>
                                    </a>
                                    <div class="flex-grow-1">
                                        {% if g.grouper %}
                                            <a href="{{ g.grouper.get_absolute_url }}" style="color: var(--theme-text-primary); text-decoration: none; font-weight: 600; font-size: var(--font-size-base); transition: var(--transition-fast);">
                                                <i class="fas fa-users mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>{{ g.grouper.name }}
                                            </a>
                                        {% else %}
                                            <span style="color: var(--theme-text-primary); font-weight: 600; font-size: var(--font-size-base);">
                                                <i class="fas fa-user mr-2" style="color: var(--color-primary); font-size: 0.9em;"></i>Solo Characters
                                            </span>
                                        {% endif %}
                                    </div>
                                    <span class="tg-badge badge-secondary badge-pill ml-2">{{ g.list|length }}</span>
                                </div>
                            </td>
                        </tr>
                        <!-- Character Rows -->
                        {% for char in g.list %}
                            {% if char.display %}
                                <tr class="collapse show character-row" id="group-{{ g.grouper.id|default:'solo' }}-{{ table_id }}" style="transition: var(--transition-fast);">
                                    <td data-label=""></td>
                                    <td data-label="Character" style="padding: 16px;">
                                        <a href="{{ char.get_absolute_url }}">{{ char.name }}</a>
                                    </td>
                                    <td data-label="Player" style="padding: 16px;">
                                        <a href="{{ char.owner.profile.get_absolute_url }}">{{ char.owner.username }}</a>
                                    </td>
                                    <td data-label="Type" style="padding: 16px;">
                                        <span class="tg-badge badge-pill {{ char.get_badge_class }}">{{ char.get_type }}</span>
                                    </td>
                                    <td data-label="Status" style="padding: 16px;">
                                        <span class="tg-badge badge-pill {% if char.status == 'App' %}badge-success{% elif char.status == 'Sub' %}badge-warning{% elif char.status == 'Dec' %}badge-danger{% elif char.status == 'Ret' %}badge-info{% else %}badge-secondary{% endif %}">{{ char.get_status_display }}</span>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="text-center py-5" style="color: var(--theme-text-muted); background: var(--theme-bg-secondary); border-radius: var(--border-radius-base); border: 2px dashed var(--theme-border-color);">
        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
        <p class="mb-0" style="font-size: var(--font-size-base);">No characters found.</p>
    </div>
{% endif %}
