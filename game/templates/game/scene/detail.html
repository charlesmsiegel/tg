{% extends "core/base.html" %}
{% block title %}
    {{ object.name }}
{% endblock title %}
{% block content %}
    {% load sanitize_text %}
    {% load field %}
    <div class="container py-4">
        <!-- Scene Header -->
        <div class="tg-card header-card mb-4" data-gameline="{{ object.chronicle.gameline }}">
            <div class="tg-card-header text-center">
                <h1 class="tg-card-title {{ object.chronicle.headings }}">{{ object.name }}</h1>
                <span class="tg-badge badge-pill" style="background-color: rgba(23, 162, 184, 0.15); color: #17a2b8; border-radius: 20px; font-size: 0.875rem; margin-top: 8px;">{{ object.date_of_scene }}</span>
            </div>
        </div>

        <!-- Location Information -->
        <div class="tg-card mb-2">
            <div class="tg-card-header text-center">
                <h3 class="tg-card-title {{ object.chronicle.headings }}">
                    <a href="{{ object.location.get_absolute_url }}" class="text-decoration-none">{{ object.location.name }}</a>
                </h3>
            </div>
            {% if object.location.description %}
                <div class="tg-card-body text-center" style="padding: 16px 20px;">
                    <p class="mb-0" style="line-height: 1.6;">{{ object.location.description|sanitize_html|linebreaks }}</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Errors Section -->
        {% block errors %}
            {% if post_form.non_field_errors %}
                <div class="tg-error-message mb-3">
                    {% for error in post_form.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
                </div>
            {% endif %}
        {% endblock errors %}
        
        <!-- Posts Section -->
        <div class="tg-card mb-4">
            <div class="tg-card-body" style="padding: 20px;">
                {% for post in object.post_set.all %}
                    <div class="mb-3" style="padding-bottom: 16px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                        <p class="post mb-0" style="line-height: 1.6;">
                            <strong {% if post.character.owner.profile.is_st %}class="st"{% elif post.character.owner == request.user %}class="highlight"{% endif %}>
                                <a href="{{ post.character.get_absolute_url }}" style="font-weight: 600;">{{ post.display_name }}</a>
                            </strong>: {{ post.message|quote_tag|sanitize_html }}
                        </p>
                    </div>
                {% empty %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">No posts yet</p>
                    </div>
                {% endfor %}
            </div>
        </div>
        <!-- Post Form -->
        {% if not object.finished %}
            {% if request.user.is_authenticated %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <form method="post" action="">
                            {% csrf_token %}
                            <div class="mb-3">
                                {% if num_logged_in_chars == 1 %}
                                    {{ first_char }}
                                {% else %}
                                    {{ post_form.character }}
                                {% endif %}
                                {{ post_form.display_name }}
                            </div>
                            <div class="mb-3">{{ post_form.message }}</div>
                            <input type="submit" value="Post" class="btn btn-primary" />
                        </form>
                    </div>
                </div>
                <!-- Add Character Form -->
                {% if num_chars != 0 %}
                    <form method="post" action="" class="mb-3">
                        {% csrf_token %}
                        {{ add_char_form.character_to_add }}
                        <input type="submit" value="Add" class="btn btn-secondary" />
                    </form>
                {% endif %}
                <!-- Close Scene Form -->
                <form method="post" action="" class="mb-3">
                    {% csrf_token %}
                    <input type="submit"
                           value="Close Scene"
                           name="close_scene"
                           class="btn btn-danger" />
                </form>
                <!-- Commands Link -->
                <div class="text-center mt-3">
                    <a href="{% url 'game:commands' %}"
                       class="btn btn-outline-primary btn-sm px-4 py-2">List of Commands</a>
                </div>
            {% endif %}
        {% endif %}
    </div>
{% endblock content %}
